<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel de Chamados - ProduÃ§Ã£o</title>

<style>
:root {
    --bg: #eef1f5;
    --card: #ffffff;
    --primary: #2563eb;
    --primary-dark: #1e40af;
    --text: #1f2937;
    --muted: #6b7280;
    --border: #e5e7eb;
    --novo: #e0f2fe;
    --finalizado: #dcfce7;
}

/* Reset e fontes */
* { box-sizing: border-box; font-family: "Segoe UI", Roboto, Arial, sans-serif; }
body { margin: 0; background: var(--bg); color: var(--text); }

/* Header */
header {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 16px 20px;
    position: sticky; top: 0; z-index: 10;
}
header h1 { margin: 0; font-size: 20px; }

/* Container */
.container { max-width: 1400px; margin: auto; padding: 20px; }

/* Cards */
.card { background: var(--card); border-radius: 14px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 20px; }

/* Filtros */
.filtros { padding: 16px; }
.filtro-grid { display: grid; grid-template-columns: repeat(3, 1fr) auto; gap: 14px; }
.filtro-grid input { padding: 12px; border-radius: 10px; border: 1px solid var(--border); font-size: 14px; }
.filtro-grid button { background: var(--primary); color: #fff; border: none; padding: 12px 22px; border-radius: 10px; font-weight: 600; cursor: pointer; }
.filtro-grid button:hover { background: var(--primary-dark); }

/* Table */
.table-wrapper { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; min-width: 1000px; }
th, td { padding: 14px; text-align: left; font-size: 14px; border-bottom: 1px solid var(--border); }
th { background: #f9fafb; font-weight: 600; color: var(--muted); }
tr:hover { background: #f3f4f6; }
tr.novo { background: var(--novo); animation: pulse 1.5s infinite; }
tr.finalizado { background: var(--finalizado); }

/* Buttons dentro da tabela */
.btn-ver { 
    padding: 6px 12px; 
    border-radius: 8px; 
    border: none; 
    cursor: pointer; 
    font-size: 13px; 
    background: var(--primary); 
    color: #fff; 
}
.btn-ver:hover { background: var(--primary-dark); }

/* Animation */
@keyframes pulse { 0% {opacity:1;} 50%{opacity:0.6;} 100%{opacity:1;} }

/* Mobile */
@media (max-width: 900px) { .filtro-grid { grid-template-columns: 1fr; } table { min-width: 100%; } }
</style>
</head>
<body>

<header>
    <h1>ðŸ“‹ Painel de Chamados â€“ ProduÃ§Ã£o</h1>
</header>

<div class="container">

    <!-- FILTROS -->
    <div class="card filtros">
        <div class="filtro-grid">
            <input type="text" id="filtroSupervisor" placeholder="Supervisor">
            <input type="text" id="filtroGalpao" placeholder="GalpÃ£o">
            <input type="text" id="filtroMaquina" placeholder="MÃ¡quina">
            <button onclick="exportarPDF()">ðŸ“„ Exportar PDF</button>
        </div>
    </div>

    <!-- TABELA -->
    <div class="card">
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Supervisor</th>
                        <th>GalpÃ£o</th>
                        <th>Grupo</th>
                        <th>MÃ¡quina</th>
                        <th>DescriÃ§Ã£o</th>
                        <th>Status</th>
                        <th>AÃ§Ãµes</th>
                        <th>Data</th>
                    </tr>
                </thead>
                <tbody id="listaChamados"></tbody>
            </table>
        </div>
    </div>

</div>

<audio id="alertSound" src="/sounds/chamado.mp3" preload="auto"></audio>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
let ultimoChamadoId = null;
let chamadosGlobais = [];
let audioLiberado = false;
const audio = document.getElementById("alertSound");
audio.volume = 1.0;

/* ================= CARREGAR ================= */
async function carregarChamados() {
    const res = await fetch("/api/listar");
    chamadosGlobais = await res.json();
    renderizarChamados(chamadosGlobais);
}

/* ================= RENDER ================= */
function renderizarChamados(lista) {
    const tbody = document.getElementById("listaChamados");
    tbody.innerHTML = "";

    lista.forEach(chamado => {
        const tr = document.createElement("tr");
        if (chamado.status === 'Finalizado') tr.classList.add("finalizado");
        else if (ultimoChamadoId && chamado.id > ultimoChamadoId) tr.classList.add("novo");

        // Status
        let statusHTML = chamado.status === 'Finalizado' 
            ? `<span style="font-weight:bold; color:green;">Finalizado</span>` 
            : `<span style="font-weight:bold; color:orange;">Aberto</span>`;

        // AÃ§Ãµes
        let acoesHTML = '';
        if (chamado.status === 'Finalizado') {
            acoesHTML = `
                <button class="btn-ver" onclick="verMecanico('${chamado.mecanico || ''}')">MecÃ¢nico</button>
                <button class="btn-ver" onclick="verSolucao('${chamado.solucao || ''}')">SoluÃ§Ã£o</button>
            `;
        } else {
            acoesHTML = `<button class="btn-ver" onclick="finalizarChamado(${chamado.id})">Finalizar</button>`;
        }

        tr.innerHTML = `
            <td>${chamado.supervisor}</td>
            <td>${chamado.galpao}</td>
            <td>${chamado.grupo}</td>
            <td>${chamado.maquina}</td>
            <td>${chamado.descricao}</td>
            <td>${statusHTML}</td>
            <td>${acoesHTML}</td>
            <td>${new Date(chamado.criado_em).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
    });

    if (lista.length > 0) {
        const maisRecente = lista[0];
        if (ultimoChamadoId && maisRecente.id > ultimoChamadoId) dispararAlerta(maisRecente);
        ultimoChamadoId = maisRecente.id;
    }
}

/* ================= FINALIZAR ================= */
async function finalizarChamado(id) {
    const mecanico = prompt("Informe o nome do mecÃ¢nico responsÃ¡vel:");
    if (!mecanico) return alert("MecÃ¢nico Ã© obrigatÃ³rio!");

    const solucao = prompt("Descreva a soluÃ§Ã£o aplicada:");
    if (!solucao) return alert("SoluÃ§Ã£o Ã© obrigatÃ³ria!");

    const res = await fetch("/api/finalizar", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, mecanico, solucao })
    });

    if (res.ok) {
        alert("Chamado finalizado com sucesso!");
        carregarChamados();
    } else {
        const err = await res.json();
        alert(err.error || "Erro ao finalizar chamado");
    }
}

/* ================= VER MECÃ‚NICO / SOLUÃ‡ÃƒO ================= */
function verMecanico(nome) { alert("MecÃ¢nico: " + nome); }
function verSolucao(solucao) { alert("SoluÃ§Ã£o: " + solucao); }

/* ================= FILTROS ================= */
function aplicarFiltros() {
    const sup = filtroSupervisor.value.toLowerCase();
    const gal = filtroGalpao.value.toLowerCase();
    const maq = filtroMaquina.value.toLowerCase();

    const filtrados = chamadosGlobais.filter(c =>
        c.supervisor.toLowerCase().includes(sup) &&
        c.galpao.toLowerCase().includes(gal) &&
        c.maquina.toLowerCase().includes(maq)
    );

    renderizarChamados(filtrados);
}

filtroSupervisor.addEventListener("input", aplicarFiltros);
filtroGalpao.addEventListener("input", aplicarFiltros);
filtroMaquina.addEventListener("input", aplicarFiltros);

/* ================= PDF ================= */
function exportarPDF() {
    const element = document.querySelector(".table-wrapper");
    html2pdf().set({ margin:0.5, filename:"chamados-producao.pdf", html2canvas:{scale:2}, jsPDF:{orientation:"landscape", format:"a4"} }).from(element).save();
}

/* ================= ALERTA ================= */
function dispararAlerta(chamado) {
    if (Notification.permission === "granted") {
        new Notification("ðŸ“¢ Novo Chamado de ProduÃ§Ã£o", { body: `MÃ¡quina: ${chamado.maquina} | GalpÃ£o: ${chamado.galpao}` });
    }
    if (audioLiberado) repetirSom(3,3000);
}

function repetirSom(vezes, intervalo) {
    let count = 0;
    const timer = setInterval(() => {
        audio.currentTime = 0;
        audio.play().catch(()=>{});
        count++;
        if(count>=vezes) clearInterval(timer);
    }, intervalo);
}

document.addEventListener("click", () => {
    if(!audioLiberado){
        audio.play().then(()=>{audio.pause(); audio.currentTime=0; audioLiberado=true;}).catch(()=>{});
    }
},{ once:true });

if(Notification.permission!=="granted"){Notification.requestPermission();}
carregarChamados();
setInterval(carregarChamados,10000);

</script>
</body>
</html>
